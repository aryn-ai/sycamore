# Repo name: arynai/sycamore-base
# Base image for other containers that need to use sycamore.
# Note: This dockerfile is intended to work with docker buildx build -f apps/docker-base/Dockerfile.buildx .

# Doesn't work with 3.12
# depends on pyarrow==12.0.1 and ray[default]<3.0.0 and >=2.7.0
FROM python:3.11

WORKDIR /app
COPY apps/docker-base/Makefile.docker-base ./
RUN make -f Makefile.docker-base user-setup

ARG POETRY_NO_INTERACTION=1 \
    POETRY_VIRTUALENVS_IN_PROJECT=1 \
    POETRY_VIRTUALENVS_CREATE=1 \
    POETRY_CACHE_DIR=/tmp/poetry_cache
 
RUN make -f Makefile.docker-base apt-setup
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    make -f Makefile.docker-base apt-install

USER app

# https://github.com/docker/buildx/issues/1408 app:app + --link isn't supported
# Begin generated by ./apps/docker-base/gen-pyproject-copy.sh
COPY --link --chown=1000:1000 ./apps/crawler/pyproject.toml ./apps/crawler/README.md ./apps/crawler/
COPY --link --chown=1000:1000 ./apps/demo-ui/openai-proxy/pyproject.toml ./apps/demo-ui/openai-proxy/README.md ./apps/demo-ui/openai-proxy/
COPY --link --chown=1000:1000 ./apps/importer/pyproject.toml ./apps/importer/README.md ./apps/importer/
COPY --link --chown=1000:1000 ./apps/integration/pyproject.toml ./apps/integration/README.md ./apps/integration/
COPY --link --chown=1000:1000 ./apps/jupyter/pyproject.toml ./apps/jupyter/README.md ./apps/jupyter/
COPY --link --chown=1000:1000 ./apps/query-ui/pyproject.toml ./apps/query-ui/README.md ./apps/query-ui/
COPY --link --chown=1000:1000 ./apps/remote-processor-service/pyproject.toml ./apps/remote-processor-service/README.md ./apps/remote-processor-service/
COPY --link --chown=1000:1000 ./lib/aryn-sdk/pyproject.toml ./lib/aryn-sdk/README.md ./lib/aryn-sdk/
COPY --link --chown=1000:1000 ./lib/poetry-lock/pyproject.toml ./lib/poetry-lock/README.md ./lib/poetry-lock/
COPY --link --chown=1000:1000 ./lib/remote-processors/pyproject.toml ./lib/remote-processors/README.md ./lib/remote-processors/
COPY --link --chown=1000:1000 ./pyproject.toml ./poetry.lock ./README.md ./
# End generated by ./apps/docker-base/gen-pyproject-copy.sh

COPY --link --chown=1000:1000 lib/sycamore lib/sycamore
COPY --link --chown=1000:1000 apps/docker-base/poetry-install.sh poetry-install.sh

RUN --mount=type=cache,id=cache_poetry_1000,target=/tmp/poetry_cache,uid=1000,gid=1000,sharing=locked \
    ./poetry-install.sh main

RUN make -f Makefile.docker-base non-root-files-check

ARG GIT_BRANCH="unknown"
ARG GIT_COMMIT="unknown"
ARG GIT_DIFF="unknown"

ENV GIT_BRANCH=${GIT_BRANCH}
ENV GIT_COMMIT=${GIT_COMMIT}
ENV GIT_DIFF=${GIT_DIFF}

LABEL org.opencontainers.image.authors="opensource@aryn.ai"
LABEL git_branch=${GIT_BRANCH}
LABEL git_commit=${GIT_COMMIT}
LABEL git_diff=${GIT_DIFF}

RUN make -f Makefile.docker-base record-version
RUN make -f Makefile.docker-base check-version-compatibility

CMD [ "echo", "base image, nothing to run here" ]
